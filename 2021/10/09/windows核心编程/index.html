<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>windows核心编程 | 0ke</title>
  <meta name="author" content="lijianbo" />

  
  <meta name="description" content="什么是进程" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <meta property="og:title" content="windows核心编程" />
  <meta property="og:site_name" content="0ke" />

  
  

  
    <meta property="og:image" content="" />
  

  
  <link href="/css/images/favicon.ico" rel="icon" />
  

  <link rel="alternate" href="/atom.xml" title="0ke" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  


  <!-- baidu webmaster push -->
  <script src='//push.zhanzhang.baidu.com/push.js'></script>

<meta name="generator" content="Hexo 6.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">0ke</a></h1>
  <h2><a href="/">Something good must happen in the future</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2021-10-09T10:23:23.000Z"><a href="/2021/10/09/windows核心编程/">2021-10-09</a></time>
      
      
  
    <h1 class="title">windows核心编程</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="什么是进程"><a href="#什么是进程" class="headerlink" title="什么是进程"></a>什么是进程</h2><span id="more"></span>

<h2 id="R3的一些进程操作"><a href="#R3的一些进程操作" class="headerlink" title="R3的一些进程操作"></a>R3的一些进程操作</h2><p>进程创建函数实现。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> EXE_PATH "C:\\Users\\rkvir\\Desktop\\010Editorl.exe"</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    SECURITY_ATTRIBUTES psa <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token number">0</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    SECURITY_ATTRIBUTES tsa <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token number">0</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    STARTUPINFO si <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    PROCESS_INFORMATION pi<span class="token punctuation">;</span>
    <span class="token function">CreateProcess</span><span class="token punctuation">(</span>EXE_PATH<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>psa<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tsa<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>通过进程的PID和进程句柄关闭进程。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//6816是可执行程序的PID</span>
    <span class="token comment" spellcheck="true">//CreateProcessR(EXE_PATH);</span>
    HANDLE hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_TERMINATE<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token number">6816</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//打开一个进程，注意是打开，不是创建。</span>
    <span class="token function">TerminateProcess</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>进程遍历</p>
<pre class=" language-c"><code class="language-c">bool <span class="token function">ProcessShow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    PROCESSENTRY32 pe32 <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token number">0</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    pe32<span class="token punctuation">.</span>dwSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PROCESSENTRY32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    HANDLE hSnapshot <span class="token operator">=</span> <span class="token function">CreateToolhelp32Snapshot</span><span class="token punctuation">(</span>TH32CS_SNAPPROCESS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//进程 线程 模块 堆 的快照API</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hSnapshot <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span> 
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CreateToolhelp32Snapshot Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    BOOL bRet <span class="token operator">=</span> <span class="token function">Process32First</span><span class="token punctuation">(</span>hSnapshot<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pe32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Process Name:%s\n"</span><span class="token punctuation">,</span> pe32<span class="token punctuation">.</span>szExeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Process ID:%s\n"</span><span class="token punctuation">,</span> pe32<span class="token punctuation">.</span>th32ProcessID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">Process32Next</span><span class="token punctuation">(</span>hSnapshot<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pe32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="R0的一些进程操作"><a href="#R0的一些进程操作" class="headerlink" title="R0的一些进程操作"></a>R0的一些进程操作</h2><p>KPROCESS结构简单说一下</p>
<pre><code>
nt!_KPROCESS
   +0x000 Header           : _DISPATCHER_HEADER		//句柄，内核中转换成对象，进行等待操作++事件
   +0x010 ProfileListHead  : _LIST_ENTRY			//双向链表，性能统计。任务管理器中的性能
   +0x018 DirectoryTableBase : Uint4B			//页表基址 CR3
   +0x01c LdtDescriptor    : _KGDTENTRY		//Ldt描述符
   +0x024 Int21Descriptor  : _KIDTENTRY		//虚拟8086中使用
   +0x02c ThreadListHead   : _LIST_ENTRY		//存放当前进程的所有线程
   +0x034 ProcessLock      : Uint4B			//进程锁，修改KPROCESS需要锁住进程。同步等待操作。可以锁可以不锁
   +0x038 Affinity         : _KAFFINITY_EX			//亲和性，代码跑在某一个核心中，以后说。
   +0x044 ReadyListHead    : _LIST_ENTRY		//双向链表，就绪链表，等待调度的进程
   +0x04c SwapListEntry    : _SINGLE_LIST_ENTRY		//单向链表 当前线程中栈空间和磁盘交换的线程
   +0x050 ActiveProcessors : _KAFFINITY_EX		//进程用到哪些核心
   +0x05c AutoAlignment    : Pos 0, 1 Bit
   +0x05c DisableBoost     : Pos 1, 1 Bit
   +0x05c DisableQuantum   : Pos 2, 1 Bit
   +0x05c ActiveGroupsMask : Pos 3, 1 Bit
   +0x05c ReservedFlags    : Pos 4, 28 Bits
   +0x05c ProcessFlags     : Int4B			//位域
   +0x060 BasePriority     : Char			//优先级
   +0x061 QuantumReset     : Char			//线程中介绍
   +0x062 Visited          : UChar
   +0x063 Unused3          : UChar
   +0x064 ThreadSeed       : [1] Uint4B
   +0x068 IdealNode        : [1] Uint2B
   +0x06a IdealGlobalNode  : Uint2B
   +0x06c Flags            : _KEXECUTE_OPTIONS		//代码在数据段无法执行，这里关掉代码可以跑在数据段。
   +0x06d Unused1          : UChar
   +0x06e IopmOffset       : Uint2B
   +0x070 Unused4          : Uint4B
   +0x074 StackCount       : _KSTACK_COUNT
   +0x078 ProcessListEntry : _LIST_ENTRY		//win7之后无法使用
   +0x080 CycleTime        : Uint8B
   +0x088 KernelTime       : Uint4B
   +0x08c UserTime         : Uint4B
   +0x090 VdmTrapcHandler  : Ptr32 Void
</code></pre>
<pre><code>EPROCESS
nt!_EPROCESS
   +0x000 Pcb              : _KPROCESS				//
   +0x098 ProcessLock      : _EX_PUSH_LOCK			//执行体进程锁	
   +0x0a0 CreateTime       : _LARGE_INTEGER			//当前进程创建时间
   +0x0a8 ExitTime         : _LARGE_INTEGER			//当前进程退出时间
   +0x0b0 RundownProtect   : _EX_RUNDOWN_REF
   +0x0b4 UniqueProcessId  : Ptr32 Void				//当前操作系统下的进程ID （这里使用的是win7x86
   +0x0b8 ActiveProcessLinks : _LIST_ENTRY			//双向链表，可以断链，但是可以在PChunter中查看到，可以欺骗进程管理器和进程快照。但是使用句柄遍历是可以看到的
   +0x0c0 ProcessQuotaUsage : [2] Uint4B			//不到啥玩仍
   +0x0c8 ProcessQuotaPeak : [2] Uint4B			
   +0x0d0 CommitCharge     : Uint4B
   +0x0d4 QuotaBlock       : Ptr32 _EPROCESS_QUOTA_BLOCK
   +0x0d8 CpuQuotaBlock    : Ptr32 _PS_CPU_QUOTA_BLOCK
   +0x0dc PeakVirtualSize  : Uint4B
   +0x0e0 VirtualSize      : Uint4B				//不到啥玩仍
   +0x0e4 SessionProcessLinks : _LIST_ENTRY			//会话进程	当前用户的进程
   +0x0ec DebugPort        : Ptr32 Void				//很重要，调试端口，古老的游戏检测需要检测这个调试端口，现在已经不怎么使用。
   +0x0f0 ExceptionPortData : Ptr32 Void
   +0x0f0 ExceptionPortValue : Uint4B
   +0x0f0 ExceptionPortState : Pos 0, 3 Bits			//异常是否上报
   +0x0f4 ObjectTable      : Ptr32 _HANDLE_TABLE			//R3私有句柄表
   +0x0f8 Token            : _EX_FAST_REF				//权限描述符，操作系统临时提权。
   +0x0fc WorkingSetPage   : Uint4B				//判断当前有多少物理页
   +0x100 AddressCreationLock : _EX_PUSH_LOCK			//锁，互斥体
   +0x104 RotateInProgress : Ptr32 _ETHREAD
   +0x108 ForkInProgress   : Ptr32 _ETHREAD
   +0x10c HardwareTrigger  : Uint4B
   +0x110 PhysicalVadRoot  : Ptr32 _MM_AVL_TABLE		//物理页
   +0x114 CloneRoot        : Ptr32 Void
   +0x118 NumberOfPrivatePages : Uint4B
   +0x11c NumberOfLockedPages : Uint4B
   +0x120 Win32Process     : Ptr32 Void				//GUI进程对象
   +0x124 Job              : Ptr32 _EJOB				//作业相关
   +0x128 SectionObject    : Ptr32 Void
   +0x12c SectionBaseAddress : Ptr32 Void
   +0x130 Cookie           : Uint4B				//指针加密，和Cookie异或
   +0x134 Spare8           : Uint4B
   +0x138 WorkingSetWatch  : Ptr32 _PAGEFAULT_HISTORY		//是否允许第三方读写本进程
   +0x13c Win32WindowStation : Ptr32 Void
   +0x140 InheritedFromUniqueProcessId : Ptr32 Void
   +0x144 LdtInformation   : Ptr32 Void
   +0x148 VdmObjects       : Ptr32 Void				//虚拟8086下使用
   +0x14c ConsoleHostProcess : Uint4B
   +0x150 DeviceMap        : Ptr32 Void
   +0x154 EtwDataSource    : Ptr32 Void				//ETW的数据源
   +0x158 FreeTebHint      : Ptr32 Void
   +0x160 PageDirectoryPte : _HARDWARE_PTE			//PTE
   +0x160 Filler           : Uint8B
   +0x168 Session          : Ptr32 Void				//所属的用户对象
   +0x16c ImageFileName    : [15] UChar				//当前进程的进程名，当进程名超过15会被截断。
   +0x17b PriorityClass    : UChar
   +0x17c JobLinks         : _LIST_ENTRY				//作业链表
   +0x184 LockedPagesList  : Ptr32 Void
   +0x188 ThreadListHead   : _LIST_ENTRY			//线程链表
   +0x190 SecurityPort     : Ptr32 Void
   +0x194 PaeTop           : Ptr32 Void
   +0x198 ActiveThreads    : Uint4B
   +0x19c ImagePathHash    : Uint4B
   +0x1a0 DefaultHardErrorProcessing : Uint4B
   +0x1a4 LastThreadExitStatus : Int4B
   +0x1a8 Peb              : Ptr32 _PEB
   +0x1ac PrefetchTrace    : _EX_FAST_REF
   +0x1b0 ReadOperationCount : _LARGE_INTEGER		//读文件+！
   +0x1b8 WriteOperationCount : _LARGE_INTEGER		//同上
   +0x1c0 OtherOperationCount : _LARGE_INTEGER
   +0x1c8 ReadTransferCount : _LARGE_INTEGER
   +0x1d0 WriteTransferCount : _LARGE_INTEGER
   +0x1d8 OtherTransferCount : _LARGE_INTEGER
   +0x1e0 CommitChargeLimit : Uint4B
   +0x1e4 CommitChargePeak : Uint4B
   +0x1e8 AweInfo          : Ptr32 Void
   +0x1ec SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO
   +0x1f0 Vm               : _MMSUPPORT				//
   +0x25c MmProcessLinks   : _LIST_ENTRY
   +0x264 HighestUserAddress : Ptr32 Void
   +0x268 ModifiedPageCount : Uint4B
   +0x26c Flags2           : Uint4B
   +0x26c JobNotReallyActive : Pos 0, 1 Bit			//位域
   +0x26c AccountingFolded : Pos 1, 1 Bit
   +0x26c NewProcessReported : Pos 2, 1 Bit
   +0x26c ExitProcessReported : Pos 3, 1 Bit
   +0x26c ReportCommitChanges : Pos 4, 1 Bit
   +0x26c LastReportMemory : Pos 5, 1 Bit
   +0x26c ReportPhysicalPageChanges : Pos 6, 1 Bit
   +0x26c HandleTableRundown : Pos 7, 1 Bit
   +0x26c NeedsHandleRundown : Pos 8, 1 Bit
   +0x26c RefTraceEnabled  : Pos 9, 1 Bit
   +0x26c NumaAware        : Pos 10, 1 Bit
   +0x26c ProtectedProcess : Pos 11, 1 Bit
   +0x26c DefaultPagePriority : Pos 12, 3 Bits
   +0x26c PrimaryTokenFrozen : Pos 15, 1 Bit
   +0x26c ProcessVerifierTarget : Pos 16, 1 Bit
   +0x26c StackRandomizationDisabled : Pos 17, 1 Bit
   +0x26c AffinityPermanent : Pos 18, 1 Bit
   +0x26c AffinityUpdateEnable : Pos 19, 1 Bit
   +0x26c PropagateNode    : Pos 20, 1 Bit
   +0x26c ExplicitAffinity : Pos 21, 1 Bit
   +0x270 Flags            : Uint4B
   +0x270 CreateReported   : Pos 0, 1 Bit
   +0x270 NoDebugInherit   : Pos 1, 1 Bit
   +0x270 ProcessExiting   : Pos 2, 1 Bit
   +0x270 ProcessDelete    : Pos 3, 1 Bit
   +0x270 Wow64SplitPages  : Pos 4, 1 Bit
   +0x270 VmDeleted        : Pos 5, 1 Bit
   +0x270 OutswapEnabled   : Pos 6, 1 Bit
   +0x270 Outswapped       : Pos 7, 1 Bit
   +0x270 ForkFailed       : Pos 8, 1 Bit
   +0x270 Wow64VaSpace4Gb  : Pos 9, 1 Bit
   +0x270 AddressSpaceInitialized : Pos 10, 2 Bits
   +0x270 SetTimerResolution : Pos 12, 1 Bit
   +0x270 BreakOnTermination : Pos 13, 1 Bit
   +0x270 DeprioritizeViews : Pos 14, 1 Bit
   +0x270 WriteWatch       : Pos 15, 1 Bit
   +0x270 ProcessInSession : Pos 16, 1 Bit
   +0x270 OverrideAddressSpace : Pos 17, 1 Bit
   +0x270 HasAddressSpace  : Pos 18, 1 Bit
   +0x270 LaunchPrefetched : Pos 19, 1 Bit
   +0x270 InjectInpageErrors : Pos 20, 1 Bit
   +0x270 VmTopDown        : Pos 21, 1 Bit
   +0x270 ImageNotifyDone  : Pos 22, 1 Bit
   +0x270 PdeUpdateNeeded  : Pos 23, 1 Bit
   +0x270 VdmAllowed       : Pos 24, 1 Bit
   +0x270 CrossSessionCreate : Pos 25, 1 Bit
   +0x270 ProcessInserted  : Pos 26, 1 Bit
   +0x270 DefaultIoPriority : Pos 27, 3 Bits
   +0x270 ProcessSelfDelete : Pos 30, 1 Bit
   +0x270 SetTimerResolutionLink : Pos 31, 1 Bit
   +0x274 ExitStatus       : Int4B
   +0x278 VadRoot          : _MM_AVL_TABLE
   +0x298 AlpcContext      : _ALPC_PROCESS_CONTEXT
   +0x2a8 TimerResolutionLink : _LIST_ENTRY
   +0x2b0 RequestedTimerResolution : Uint4B
   +0x2b4 ActiveThreadsHighWatermark : Uint4B
   +0x2b8 SmallestTimerResolution : Uint4B
   +0x2bc TimerResolutionStackRecord : Ptr32 _PO_DIAG_STACK_RECORD
</code></pre>
<p>驱动遍历进程代码</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ntifs.h></span></span>

VOID <span class="token function">ShowProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    DWORD_PTR pEprocess <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">//兼容性更强</span>
    ULONG ulProcessid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ULONG ulProcessName <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pEprocess <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD_PTR<span class="token punctuation">)</span><span class="token function">PsGetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取当前进程的EPROCESS结构</span>
    <span class="token comment" spellcheck="true">//双向链表遍历进程</span>
    PLIST_ENTRY ActiveProcessLinks <span class="token operator">=</span> <span class="token punctuation">(</span>PLIST_ENTRY<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pEprocess <span class="token operator">+</span> <span class="token number">0xb8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PLIST_ENTRY NextList <span class="token operator">=</span> ActiveProcessLinks<span class="token operator">-></span>Flink<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>NextList<span class="token operator">-></span>Flink <span class="token operator">!=</span> ActiveProcessLinks<span class="token operator">-></span>Flink<span class="token punctuation">)</span> 
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        pEprocess <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD_PTR<span class="token punctuation">)</span>NextList <span class="token operator">-</span> <span class="token number">0xb8</span><span class="token punctuation">;</span>
        ulProcessid <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pEprocess <span class="token operator">+</span> <span class="token number">0xb4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ulProcessName <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG<span class="token punctuation">)</span><span class="token punctuation">(</span>pEprocess <span class="token operator">+</span> <span class="token number">0x16C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"Processid = %d\r\nProcessName = %s"</span><span class="token punctuation">,</span> ulProcessid<span class="token punctuation">,</span> ulProcessName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NextList <span class="token operator">=</span> NextList<span class="token operator">-></span>Flink<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DriverUnload</span><span class="token punctuation">(</span>PDRIVER_OBJECT pDriver0bject<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"Unload\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

NTSTATUS <span class="token function">DriverEntry</span><span class="token punctuation">(</span>PDRIVER_OBJECT pDriver0bject<span class="token punctuation">,</span> PUNICODE_STRING pRegPath<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    pDriver0bject<span class="token operator">-></span>DriverUnload <span class="token operator">=</span> DriverUnload<span class="token punctuation">;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"Hello\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ShowProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>ed nt!kd_fusion_mask 0  windbg关闭日志，我一跑驱动咔咔刷屏真是醉了，谢谢马主任。</p>
<p>断链隐藏进程&#x3D;&#x3D;没啥用，玩玩。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>ulProcessid <span class="token operator">==</span> ulPid<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            NextList<span class="token operator">-></span>Blink<span class="token operator">-></span>Flink <span class="token operator">=</span> NextList<span class="token operator">-></span>Flink<span class="token punctuation">;</span>
            NextList<span class="token operator">-></span>Flink<span class="token operator">-></span>Blink <span class="token operator">=</span> NextList<span class="token operator">-></span>Blink<span class="token punctuation">;</span>

            <span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>							就是双向链表断链操作。
</code></pre>
<p>虚假的进程保护&#x3D;&#x3D;&#x3D;&#x3D;不保护了，直接杀死进程。</p>
<p>杀死进程。</p>
<pre class=" language-C"><code class="language-C">NTSTATUS KillProcess(ULONG ulPid)
&#123;
    NTSTATUS ntStatus = STATUS_UNSUCCESSFUL;
    PEPROCESS pEprocess = NULL;
    ntStatus = PsLookupProcessByProcessId(ulPid, &pEprocess);
    if (NT_SUCCESS(ntStatus))
    &#123;
        KeAttachProcess(pEprocess);						//附加进程，例如调试器
        for (int i = 0; i <= 0x10000000; i += 0x1000)
        &#123;
            if (MmIsAddressValid((PVOID)i))
            &#123;
                __try
                &#123;
                    ProbeForWrite((PVOID)i, 0x1000, sizeof(ULONG));
                    memset(((PVOID)i),0xcc,0x1000);
                &#125;
                __except(1)
                &#123;
                    continue; 
                &#125;
                //异常处理
            &#125;
        &#125;
        KeDetachProcess();						//解除附加
        return TRUE;
    &#125;
    return ntStatus;
&#125;
</code></pre>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//线程R3 TEB R0 ETHREAD</span>
    <span class="token comment" spellcheck="true">//FS：[0] = TEB</span>
    <span class="token comment" spellcheck="true">//TEB 0x30 = PEB</span>
    <span class="token comment" spellcheck="true">//FS:[30]</span>
    <span class="token keyword">return</span> <span class="token number">0</span>；
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="线程的创建"><a href="#线程的创建" class="headerlink" title="线程的创建"></a>线程的创建</h3><p>进程创建的时候，主线程随之创建，main函数就是主函数的回调函数，主进程销毁，主线程销毁。</p>
<h3 id><a href="#" class="headerlink" title></a></h3>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:0ke.github.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2022/04/19/驱动过滤-串口过滤/">驱动过滤--串口过滤</a>
      </li>
    
      <li>
        <a href="/2021/11/10/主动防御系统说明/">主动防御系统说明</a>
      </li>
    
      <li>
        <a href="/2021/10/26/基于MFC的驱动加载工具/">基于MFC的驱动加载工具</a>
      </li>
    
      <li>
        <a href="/2021/10/09/windows核心编程/">windows核心编程</a>
      </li>
    
      <li>
        <a href="/2021/09/15/逆向/">逆向</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/随笔/">随笔</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  <p>
  
  &copy; 2022 lijianbo
  
  All rights reserved.</p>
  <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</div>
<div class="clearfix"></div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id='bg'></div>
</body>
</html>