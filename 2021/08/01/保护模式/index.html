<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>保护模式 | 0ke</title>
  <meta name="author" content="lijianbo" />

  
  <meta name="description" content="前言" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <meta property="og:title" content="保护模式" />
  <meta property="og:site_name" content="0ke" />

  
  

  
    <meta property="og:image" content="" />
  

  
  <link href="/css/images/favicon.ico" rel="icon" />
  

  <link rel="alternate" href="/atom.xml" title="0ke" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  


  <!-- baidu webmaster push -->
  <script src='//push.zhanzhang.baidu.com/push.js'></script>

<meta name="generator" content="Hexo 6.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">0ke</a></h1>
  <h2><a href="/">Something good must happen in the future</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2021-08-01T03:14:38.000Z"><a href="/2021/08/01/保护模式/">2021-08-01</a></time>
      
      
  
    <h1 class="title">保护模式</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><span id="more"></span>

<p>​		补充：百度，rkvir的视频。</p>
<h2 id="寄存器基础"><a href="#寄存器基础" class="headerlink" title="寄存器基础"></a>寄存器基础</h2><p>​		了解即可。</p>
<h3 id="通用寄存器的构成"><a href="#通用寄存器的构成" class="headerlink" title="通用寄存器的构成"></a>通用寄存器的构成</h3><p><img src="/images/42.PNG"></p>
<p><img src="/images/43.PNG"></p>
<h3 id="浮点寄存器"><a href="#浮点寄存器" class="headerlink" title="浮点寄存器"></a>浮点寄存器</h3><p><img src="/images/44.PNG"></p>
<h3 id="段寄存器与指令指针寄存器"><a href="#段寄存器与指令指针寄存器" class="headerlink" title="段寄存器与指令指针寄存器"></a>段寄存器与指令指针寄存器</h3><p><img src="/images/45.PNG"></p>
<p>TLS是线程本地存储。段寄存器，段选择子。作为保护模式重点。</p>
<h2 id="EFLAGS寄存器基础"><a href="#EFLAGS寄存器基础" class="headerlink" title="EFLAGS寄存器基础"></a>EFLAGS寄存器基础</h2><p><img src="/images/47.PNG"></p>
<h3 id="状态标志位、控制标志位、系统标志位"><a href="#状态标志位、控制标志位、系统标志位" class="headerlink" title="状态标志位、控制标志位、系统标志位"></a>状态标志位、控制标志位、系统标志位</h3><p>pushf</p>
<p>popf</p>
<p>以上两条指令是对EFLAGS的低16位进行栈操作。</p>
<p>pushfd</p>
<p>popfd</p>
<p>以上两条指令是对EFLAGS的低32位进行栈操作。</p>
<p>pushfq</p>
<p>popfq</p>
<p>64位</p>
<h3 id="状态标志位"><a href="#状态标志位" class="headerlink" title="状态标志位"></a>状态标志位</h3><p><img src="/images/46.PNG"></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Reverse-xiaoyu/p/11397584.html">https://www.cnblogs.com/Reverse-xiaoyu/p/11397584.html</a></p>
<p>这篇博客记录的非常详细。看就完了。</p>
<h2 id="页的基本概念"><a href="#页的基本概念" class="headerlink" title="页的基本概念"></a>页的基本概念</h2><p>32位 的寻址空间 0—FFFFFFFF</p>
<p>应用层2G	0x0—7FFFFFFF</p>
<p>内核层2G	0x8—0xFFFFFFFF</p>
<p>内核层2G是共享内存</p>
<p>应用层2G是独立的，虚拟的，并且具备隔离的。页限制，页保护。</p>
<p><img src="/images/48.png"></p>
<h2 id="段权限Lab"><a href="#段权限Lab" class="headerlink" title="段权限Lab"></a>段权限Lab</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _asm<span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//mov ax, cs;</span>
        <span class="token comment" spellcheck="true">//ds=cs</span>

        <span class="token comment" spellcheck="true">//mov ds, ax;</span>
        <span class="token comment" spellcheck="true">//cs:[val]</span>
        mov ebx<span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
        mov dword ptr<span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">,</span> ebx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="base与Limit-Lab"><a href="#base与Limit-Lab" class="headerlink" title="base与Limit Lab"></a>base与Limit Lab</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> val2 <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    _asm<span class="token punctuation">{</span>
        mov eax<span class="token punctuation">,</span> dword ptr ds<span class="token punctuation">:</span><span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">;</span>
        mov dword ptr ds <span class="token punctuation">:</span> <span class="token punctuation">[</span>val2<span class="token punctuation">]</span><span class="token punctuation">,</span> eax<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>执行以上代码时，可以成功编译。但是当执行以下代码时，编译器会报错：0x00FB13CE 处有未经处理的异常(在 ConsoleApplication1.exe 中):  0xC0000005:  读取位置 0x00000000 时发生访问冲突。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> val2 <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    _asm<span class="token punctuation">{</span>
        mov eax<span class="token punctuation">,</span> dword ptr ds<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        mov dword ptr ds <span class="token punctuation">:</span> <span class="token punctuation">[</span>val2<span class="token punctuation">]</span><span class="token punctuation">,</span> eax<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>但当将段改为fs时，编译器仍然能编译通过。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> val2 <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    _asm<span class="token punctuation">{</span>
        mov eax<span class="token punctuation">,</span> dword ptr ds<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        mov dword ptr ds <span class="token punctuation">:</span> <span class="token punctuation">[</span>val2<span class="token punctuation">]</span><span class="token punctuation">,</span> eax<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里涉及到一个段.base的概念。</p>
<p>CS、SS、ES、DS段的base都是0，而FS的base是7FFDE000</p>
<p><img src="/images/50.png"></p>
<p>FS.base里存的是一个结构的地址，实质上是取到了一个结构的地址。FS：[0]</p>
<p>在windbg中dt nt!_TEB查看。</p>
<p><img src="/images/51.png"></p>
<p>可以看到，0地址是NtTib，也就是说FS：[0]取到了NtTib后面的结构内容。跟进一下结构内容。</p>
<p><img src="/images/52.png"></p>
<p>0x18处存储了FS的base。也就是说可以通过0x18找到FS的base。</p>
<p><strong>在保护模式当中：段.base + offset(逻辑地址)</strong></p>
<p> <strong>&#x3D; 线性地址。</strong></p>
<p><img src="/images/50.png"></p>
<p>再来看一下这个，除了0意外每个段还有一个limit，也就是0后（）内的值。</p>
<p>这个值是限制长度。</p>
<p>4GB</p>
<p>0x0-0xFFFFFFFF</p>
<p>但是FS的Limit只有0x0-0xFFF。</p>
<h2 id="段选择子拆解获取段描述符"><a href="#段选择子拆解获取段描述符" class="headerlink" title="段选择子拆解获取段描述符"></a>段选择子拆解获取段描述符</h2><p>Segment Selector结构是16位，它是一个段的标识符，结构如下。</p>
<p><img src="/images/53.png"></p>
<p>RPL（Requested Privilege Level）：请求访问者所使用的权限级别，从0到3级。</p>
<p>TI（Table Indicator）：描述符表索引位。当TI&#x3D;0时，从GDT（全局描述符表）查找；当TI&#x3D;1时，从LDT（本地描述符表）查找。</p>
<p>Index（Descriptor Index）：这是Descriptor在GDT&#x2F;LDT中的序号，根据TI的值在相应的描述表中查找descriptor(描述符号，，我英文不太好，不好意思)。</p>
<p>将所选择段的段选择子，换算成二进制，在根据他的结构。和相应的windbg指令，就可以找到段描述符。</p>
<p>下面进行lab。</p>
<p>首先将VS中的寄存器窗口打开，并且显示CPU段。</p>
<p><img src="/images/55.png"></p>
<p>拆解DS为例子，DS &#x3D; 0023，将其转换成2进制。100011，<strong>这里注意：0023是十六进制</strong>，并且100011要补全成。也就是。00100 0 11</p>
<p>GDT全局描述符表8位一项。</p>
<p>0000 0000 0000 0100		0100换算成十进制是4，也就是数组的第四项。</p>
<p>在windbg中，r是查看寄存器指令。</p>
<p><img src="/images/56.png"></p>
<p>和GDTR和GDTL是两个和GDT有关的伪寄存器。通过r gdtr查询GDT表位置。r gdtl查询GDT表的长度。</p>
<p><img src="/images/57.png"></p>
<p>dq 查询GDT的内容。</p>
<p><img src="/images/58.png"></p>
<p>第四项00cff300&#96;0000ffff就是段描述符。</p>
<h2 id="段描述符拆解"><a href="#段描述符拆解" class="headerlink" title="段描述符拆解"></a>段描述符拆解</h2><p>下面对段描述符进行拆解，首先，看一下段描述符的结构。</p>
<p><img src="/images/54.png"></p>
<p>上次实验得到的00cff300&#96;0000ffff根据结构进行拆解。</p>
<p>转换成二进制</p>
<p>0000 0000 1100 1111 1111 0011 0000 0000 </p>
<p>0000 0000 0000 0000 1111 1111 1111 1111</p>
<p>上面是高32位，下面是低32位。</p>
<p>Base:0000 0000 0000 0000 0000 0000 0000 0000——-000000</p>
<p>Limit:1111 1111 1111 1111 1111——-FFFFF</p>
<p>Type:0011</p>
<p>S:1</p>
<p>DPL:11</p>
<p>P:1</p>
<p>AVL:0​</p>
<p>DEF:0</p>
<p>D&#x2F;B:1</p>
<p>G:1</p>
<h2 id="Type位与G位"><a href="#Type位与G位" class="headerlink" title="Type位与G位"></a>Type位与G位</h2><p>Type生效的前提，是S位&#x3D;1。用于描述执行权限和所在段。</p>
<p>G位决定单位。</p>
<p>当G &#x3D; 1，Limit单位是页。需要*页的大小，0x1000，4096个字节。</p>
<p>当G &#x3D; 0，Limit单位是字节。</p>
<h2 id="进一步验证base的存在"><a href="#进一步验证base的存在" class="headerlink" title="进一步验证base的存在"></a>进一步验证base的存在</h2><p>篡改ds.base，段描述符。利用新造段选择子，来改变ds.base</p>
<p><img src="/images/59.png"></p>
<p>GDT表中的第9项是0，可以篡改。</p>
<p>9的bin是1001 补全之后是01001 011后三位按照常规格式填写。十六进制也就是4B.</p>
<p>在windbg中修改内存使用e指令。将第九项改成f0cff300&#96;0000ffff</p>
<p><img src="/images/60.png"></p>
<p><img src="/images/61.png"></p>
<p><img src="/images/62.png"></p>
<p>0xF0D48000 &#x3D;  0xF00000000 + 0x00D48000</p>
<p>进一步证实了base的存在。</p>
<h2 id="G位功能"><a href="#G位功能" class="headerlink" title="G位功能"></a>G位功能</h2>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:0ke.github.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2022/04/19/驱动过滤-串口过滤/">驱动过滤--串口过滤</a>
      </li>
    
      <li>
        <a href="/2021/11/10/主动防御系统说明/">主动防御系统说明</a>
      </li>
    
      <li>
        <a href="/2021/10/26/基于MFC的驱动加载工具/">基于MFC的驱动加载工具</a>
      </li>
    
      <li>
        <a href="/2021/10/09/windows核心编程/">windows核心编程</a>
      </li>
    
      <li>
        <a href="/2021/09/15/逆向/">逆向</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/随笔/">随笔</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  <p>
  
  &copy; 2022 lijianbo
  
  All rights reserved.</p>
  <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</div>
<div class="clearfix"></div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id='bg'></div>
</body>
</html>